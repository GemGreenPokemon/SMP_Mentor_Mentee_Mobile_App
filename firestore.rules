rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.role == 'super_admin';
    }
    
    function isInUniversity(universityPath) {
      return isAuthenticated() && (
        (request.auth.token.university_path != null && request.auth.token.university_path == universityPath) ||
        isSuperAdmin() ||  // Super admins can access any university
        hasRole('developer')  // Developers can access any university
      );
    }
    
    // Universities collection - only super admins can manage
    match /universities/{universityId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    // University-specific data
    match /{universityPath}/data {
      // Users collection
      match /users/{userId} {
        allow read: if isInUniversity(universityPath) && (
          isOwner(userId) || 
          hasRole('coordinator') || 
          hasRole('developer')
        );
        allow create: if isInUniversity(universityPath) && (
          hasRole('coordinator') || 
          hasRole('developer') ||
          isSuperAdmin()
        );
        allow update: if isInUniversity(universityPath) && (
          isOwner(userId) || 
          hasRole('coordinator') || 
          hasRole('developer')
        );
        allow delete: if isInUniversity(universityPath) && (
          hasRole('coordinator') || 
          hasRole('developer')
        );
        
        // User subcollections - matches all documents in any subcollection
        match /{document=**} {
          allow read, write: if isInUniversity(universityPath) && isOwner(userId);
        }
      }
      
      // Conversations collection (NEW)
      match /conversations/{conversationId} {
        function isParticipant() {
          return isAuthenticated() && 
                 isInUniversity(universityPath) &&
                 request.auth.uid in resource.data.participants;
        }
        
        function isValidParticipant() {
          return isAuthenticated() && 
                 isInUniversity(universityPath) &&
                 request.auth.uid in request.resource.data.participants;
        }
        
        // Read conversation if participant
        allow read: if isParticipant();
        
        // Create conversation if user is a participant
        allow create: if isValidParticipant()
          && request.resource.data.participants.size() >= 2
          && request.resource.data.keys().hasAll(['participants', 'created_at', 'type']);
        
        // Update only specific fields
        allow update: if isParticipant()
          && !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['participants', 'created_at']);
        
        // Don't allow deletion of conversations
        allow delete: if false;
        
        // Messages subcollection
        match /messages/{messageId} {
          allow read: if isParticipant();
          
          allow create: if isParticipant()
            && request.auth.uid == request.resource.data.sender_id
            && request.resource.data.keys().hasAll(['message', 'sender_id', 'sent_at', 'type'])
            && request.resource.data.message is string
            && request.resource.data.message.size() > 0
            && request.resource.data.message.size() < 5000;
          
          // Messages are immutable (no edit/delete)
          allow update: if false;
          allow delete: if false;
        }
        
        // Typing status subcollection
        match /typing_status/{userId} {
          allow read: if isParticipant();
          allow write: if isParticipant() && request.auth.uid == userId;
        }
      }
      
      // Meetings collection
      match /meetings/{meetingId} {
        allow read: if isInUniversity(universityPath);
        allow write: if isInUniversity(universityPath) && (
          hasRole('mentor') || 
          hasRole('mentee') || 
          hasRole('coordinator')
        );
      }
      
      // Announcements collection
      match /announcements/{announcementId} {
        allow read: if isInUniversity(universityPath);
        allow write: if isInUniversity(universityPath) && (
          hasRole('coordinator') || 
          hasRole('developer')
        );
      }
      
      // Mentorships collection
      match /mentorships/{mentorshipId} {
        allow read: if isInUniversity(universityPath);
        allow write: if isInUniversity(universityPath) && (
          hasRole('coordinator') || 
          hasRole('developer')
        );
      }
      
      // Catch-all for other collections at the data level
      match /{collection}/{document} {
        allow read: if isInUniversity(universityPath) && 
          collection != 'users' && 
          collection != 'conversations' && 
          collection != 'meetings' && 
          collection != 'announcements' &&
          collection != 'mentorships';
        allow write: if isInUniversity(universityPath) && (
          hasRole('coordinator') || 
          hasRole('developer')
        ) &&
          collection != 'users' && 
          collection != 'conversations' && 
          collection != 'meetings' && 
          collection != 'announcements' &&
          collection != 'mentorships';
      }
    }
    
    // University settings
    match /{universityPath}/settings {
      allow read: if isInUniversity(universityPath);
      allow write: if isInUniversity(universityPath) && (
        hasRole('coordinator') || 
        hasRole('developer')
      );
    }
    
    // Development/Testing override - REMOVE IN PRODUCTION
    // Uncomment the line below to allow all access for testing
    match /{document=**} { allow read, write: if true; }
  }
}